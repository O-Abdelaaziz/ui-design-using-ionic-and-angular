<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title class="ion-text-center ion-text-uppercase">cart</ion-title>
    <ion-buttons slot="start">
      <ion-back-button mode="md" [defaultHref]="previousUrl()" color="light"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  @if (cartItems().length > 0) {
    <ion-item lines="none" class="cart-items">
      <ion-label>
        {{ itemCount }} <span>items in cart</span>
      </ion-label>
      <ion-button fill="clear" slot="end" color="danger" size="small" (click)="onClearCart()">
        <ion-icon name="trash"></ion-icon>
      </ion-button>
    </ion-item>

    @for (item of cartItems(); track $index) {
      <ion-card class="cart-item">
        <ion-item lines="none">
          <ion-thumbnail>
            <img [src]="item.cover" [alt]="item.name" loading="lazy"/>
          </ion-thumbnail>

          <ion-label>
            <strong>{{ item.name }}</strong>
            <p class="price">
              <ion-text color="primary">
                <span>{{ item.price | currency }}</span>
              </ion-text>
            </p>
          </ion-label>

          <ion-col slot="end" size="2">
            <ion-row>
              <ion-button fill="clear" color="danger" size="small" (click)="onAddQuantity(item)">
                <ion-icon name="add" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-row>

            <ion-row class="ion-text-center quantity">
              <ion-text>
                <strong>{{ item.quantity }}</strong>
              </ion-text>
            </ion-row>

            <ion-row>
              <ion-button fill="clear" color="danger" size="small" (click)="onRemoveFromCart(item)">
                <ion-icon name="remove" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-row>
          </ion-col>
        </ion-item>
      </ion-card>
    }

    <ion-list lines="none" class="billing">
      <ion-list-header>
        <ion-label color="tertiary">
          Billing Details
        </ion-label>
      </ion-list-header>

      <ion-item-group>
        <ion-item>
          <ion-label color="dark">Item Total</ion-label>
          <ion-text slot="end" color="dark">
            {{ totalPrice | number: '0.2-2' }}
          </ion-text>
        </ion-item>

        <ion-item class="delivery-fee">
          <ion-label color="dark"> Delivery fee</ion-label>
          <ion-text slot="end" color="dark">
            {{ totalPrice * 0.1 | number: '0.2-2' }}
          </ion-text>
        </ion-item>

        <ion-item class="dashed-border-top">
          <ion-label color="dark"><strong>To Pay</strong></ion-label>
          <ion-text slot="end" color="dark">
            <strong>
<!--              {{ totalPrice + totalPrice * 0.1 | number: '0.2-2' }}-->
              {{
                (totalPrice + (totalPrice * 0.1) -
                  (appliedCoupon ? (totalPrice * appliedCoupon.discount) : 0)) | number: '0.2-2'
              }}
            </strong>
          </ion-text>
        </ion-item>
      </ion-item-group>
    </ion-list>

    <ion-item button (click)="applyCoupon()" detail="true" class="ion-margin coupon-item">
      <ion-icon name="pricetag" slot="start" color="success"></ion-icon>
      @if (!appliedCoupon) {
        <ion-label color="success">
          Add Coupon Code
        </ion-label>
      } @else {
        <ion-text color="success">
          <small>Coupon Applied</small>
          <div>{{ appliedCoupon.code }} - {{ appliedCoupon.discount * 100 }}% off</div>
        </ion-text>
      }
      @if (appliedCoupon) {
        <ion-text slot="end" color="success">
          -{{ (totalPrice * appliedCoupon.discount) | number: '0.2-2' }}
        </ion-text>
      }
    </ion-item>
  } @else {
    <app-empty></app-empty>
  }

  <ion-list lines="none" class="billing ion-margin-top">
    <ion-list-header>
      <ion-label color="tertiary">
        Delivery Address
      </ion-label>
      <ion-button fill="clear" size="small" (click)="openAddressModal()">
        <ion-icon name="create" slot="start"></ion-icon>
        {{ selectedAddress ? 'Change' : 'Add' }}
      </ion-button>
    </ion-list-header>

    @if (selectedAddress) {
      <ion-item lines="none" class="address-details">
        <ion-icon name="location" slot="start" color="primary"></ion-icon>
        <ion-label class="ion-text-wrap">
          <h3>{{ selectedAddress.fullName }}</h3>
          <p>{{ selectedAddress.phone }}</p>
          <p>{{ selectedAddress.addressLine1 }}</p>
          @if (selectedAddress.addressLine2) {
            <p>{{ selectedAddress.addressLine2 }}</p>
          }
          <p>
            {{ selectedAddress.city }},
            {{ selectedAddress.state }},
            {{ selectedAddress.postalCode }}
          </p>
          <p>{{ selectedAddress.country }}</p>
          @if (selectedAddress.isDefault) {
            <ion-badge color="primary">Default</ion-badge>
          }
        </ion-label>
      </ion-item>
    } @else {
      <ion-item button lines="none" (click)="openAddressModal()" class="ion-margin-top">
        <ion-icon name="add-circle" slot="start" color="primary"></ion-icon>
        <ion-label color="primary">Add Delivery Address</ion-label>
      </ion-item>
    }
  </ion-list>


<!--  <ion-modal [isOpen]="isModalOpen()" [presentingElement]="presentingElement">-->
<!--    <ng-template>-->
<!--     <app-address (close)="setClose()"></app-address>-->
<!--    </ng-template>-->
<!--  </ion-modal>-->
</ion-content>

@if (cartItems()) {
  <ion-footer class="ion-no-border">
    <ion-toolbar>
      <ion-button expand="block" color="primary" mode="ios"
                  class="ion-padding-start ion-padding-end ion-padding-bottom"
                  (click)="openAddressModal()">
        <ion-icon name="card" slot="start"></ion-icon>
        <ion-text>Checkout</ion-text>
      </ion-button>
    </ion-toolbar>
  </ion-footer>
}
